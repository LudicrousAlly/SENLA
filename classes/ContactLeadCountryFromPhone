public class ContactLeadCountryFromPhone {

    public static void updateCountry(List<sObject> objects){
        Http http = new Http();
        HttpRequest request = new HttpRequest();
        CountryCodeRequest__mdt countryCodeRequest = CountryCodeRequest__mdt.getAll().values()[0];
        String callingCodeURL = countryCodeRequest.RequestURL__c;
        String accessKey = countryCodeRequest.AccessKey__c;
        request.setMethod('GET');
        
        List<sObject> editableObjects = new List<sObject>(); //Our 'objects' that we are able to edit
        for(sObject obj: objects){
            sObject objToAdd;
            try {
            	objToAdd = [SELECT Id, Name, Country_From_Phone__c, Phone FROM Contact WHERE Id=:obj.get('Id').toString()];
            }
            catch(exception e) {
                objToAdd = [SELECT Id, Name, Country_From_Phone__c, Phone FROM Lead WHERE Id=:obj.get('Id').toString()];
            }
            editableObjects.add(objToAdd);
        }
        
        Map<String, List<sObject>> objectsByPhoneCode = new Map<String, List<sObject>>();
        for(sObject obj: editableObjects){
            String phoneCode;
            phoneCode = obj.get('Phone').toString().substringBetween('+', '-');
            
            if(objectsByPhoneCode.get(phoneCode) == null) {
                objectsByPhoneCode.put(phoneCode, new List<sObject> { obj });
            } else {
                objectsByPhoneCode.get(phoneCode).add(obj);
            }
        }
        
        List<sObject> objectsToUpdate = new List<sObject>();
        for(String phoneCode: objectsByPhoneCode.keySet()){
            request.setEndpoint(callingCodeURL+phoneCode+'?access_key='+accessKey);
            HttpResponse response = http.send(request);
            String countryName;
            
            if( response.getBody().substringBetween('[{', '}]') == null ){
                Map<String,Object> data = (Map<String,Object>)JSON.deserializeUntyped(response.getBody());
                countryName = (String)data.get('name');
            }
            else{
                List<Object> fieldList = (List<Object>)JSON.deserializeUntyped(response.getBody());
                for(Object fld : fieldList){    
                    Map<String,Object> data = (Map<String,Object>)fld;	
                    countryName = data.get('name').toString();
                }
            }
            
            for(sObject obj: objectsByPhoneCode.get(phoneCode)){           
                obj.put('Country_from_Phone__c', countryName);                
                objectsToUpdate.add(obj);
            }
        }
        update objectsToUpdate;

    }
    
}
